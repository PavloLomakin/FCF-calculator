<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intrinsic Value Calculator</title>
    <!-- Google Fonts: Roboto for general text, Roboto Mono for code/math -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <style>
        /* Define CSS Variables for easy theme management */
        :root {
            --primary-color: #4CAF50; /* Green for main actions/highlights */
            --secondary-color: #2196F3; /* Blue for secondary highlights/links */
            --background-light: #f4f7f6; /* Light background for the page */
            --background-dark: #e0e5e9; /* Slightly darker background for math section */
            --text-color: #333; /* Dark grey for main text */
            --border-color: #ccc; /* Light grey for borders */
            --shadow-light: rgba(0, 0, 0, 0.1); /* Light shadow for depth */
            --shadow-medium: rgba(0, 0, 0, 0.15); /* Medium shadow for interactive elements */
            --error-color: #f44336; /* Red for errors/pessimistic scenarios */
            --success-color: #4CAF50; /* Green for success/optimistic scenarios */
            --warning-color: #FFC107; /* Amber for additional metrics */
        }

        /* Basic Body Styling */
        body {
            font-family: 'Roboto', sans-serif;
            max-width: 1200px; /* Max width for content */
            margin: 15px auto; /* Further reduced margin */
            padding: 15px; /* Further reduced padding */
            background: var(--background-light);
            color: var(--text-color);
            line-height: 1.4; /* Further reduced line height for compactness */
            box-shadow: 0 4px 15px var(--shadow-light);
            border-radius: 12px;
            box-sizing: border-box;
        }

        /* Heading Styling */
        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 20px; /* Further reduced margin */
            font-size: 2em; /* Slightly smaller font size */
            text-shadow: 1px 1px 2px var(--shadow-light);
        }

        /* Container for Input Fields and Additional Metrics */
        .input-and-metrics-container {
            display: flex; /* Use flexbox to arrange items side-by-side */
            gap: 20px; /* Space between the two columns */
            margin-bottom: 20px; /* Space below this container */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            align-items: flex-start; /* Align items to the top */
        }

        .input-fields-column {
            flex: 1; /* Allow this column to grow */
            min-width: 280px; /* Minimum width for the input column */
            max-width: 400px; /* Max width to prevent it from getting too wide */
        }

        /* Form Input Group Styling */
        .input-group {
            margin-bottom: 10px; /* Further reduced margin */
        }

        label {
            display: block;
            margin-bottom: 5px; /* Further reduced margin */
            font-weight: 700;
            color: #555;
            font-size: 0.95em; /* Slightly smaller font size */
        }

        input[type="text"],
        input[type="number"] {
            /* Adjusted width to be narrower, allowing for 10 digits + padding */
            width: 12ch; /* Approximately 10 characters plus some buffer */
            max-width: 100%; /* Ensures it doesn't exceed parent width on small screens */
            padding: 8px; /* Further reduced padding */
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9em; /* Slightly smaller font size */
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 8px rgba(33, 150, 243, 0.2);
            outline: none;
        }

        /* Button Styling */
        button {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px; /* Further reduced padding */
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em; /* Slightly smaller font size */
            font-weight: 700;
            width: 100%;
            margin-top: 12px; /* Further reduced margin */
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px var(--shadow-light);
        }

        button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        /* Results Grid Layout */
        .results-grid {
            display: grid;
            /* On wider screens, try to fit 3 columns, then 2, then 1 */
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 15px; /* Further reduced gap */
            margin-top: 20px; /* Further reduced margin */
        }

        /* Styling for all output sections */
        .output, .math, .extra { /* .extra is now styled here too */
            background: #fff;
            padding: 12px; /* Further reduced padding */
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--shadow-light);
            font-size: 0.9em; /* Slightly smaller font size */
            border-left: 5px solid var(--primary-color);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* Specific colors for scenario outputs */
        .output.pessimistic {
            border-left-color: var(--error-color);
        }

        .output.optimistic {
            border-left-color: var(--success-color);
        }

        /* Strong text within output sections */
        .output strong {
            color: var(--secondary-color);
            font-size: 1em; /* Adjusted font size */
        }
        .output.pessimistic strong {
            color: var(--error-color);
        }
        .output.optimistic strong {
            color: var(--success-color);
        }

        /* Heading within output sections */
        .output h3, .extra h3, .math h3 {
            font-size: 1.05em; /* Slightly smaller heading font size */
            margin-top: 0;
            margin-bottom: 8px; /* Further reduced margin */
            color: #444;
        }

        /* Math Section Styling */
        .math {
            font-family: 'Roboto Mono', monospace;
            background: var(--background-dark);
            white-space: pre-wrap;
            font-size: 0.8em; /* Further reduced for math details */
            border-left-color: #9E9E9E;
        }
        .math p { /* Target paragraphs within math for tighter spacing */
            margin-bottom: 0.5em;
        }

        /* Extra Metrics Section Styling (now positioned differently) */
        .extra {
            border-left-color: var(--warning-color);
            flex: 1; /* Allow it to take available space */
            min-width: 300px; /* Minimum width for the metrics column */
        }

        .extra p {
            margin-bottom: 0.4em; /* Reduced spacing between paragraphs in metrics */
        }
        .extra p:last-child {
            margin-bottom: 0; /* No margin after the last paragraph */
        }


        /* Recommendation Widget Styling */
        #recommendation-widget {
            margin-top: 25px; /* Further reduced margin */
            padding: 15px; /* Further reduced padding */
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--shadow-light);
            text-align: center;
            border-top: 1px dashed var(--border-color);
        }

        #recommendation-widget h2 {
            color: var(--secondary-color);
            margin-bottom: 12px; /* Further reduced margin */
            font-size: 1.5em; /* Slightly smaller font size */
        }

        /* Finnhub widget container specific height */
        .finnhub-widget-container {
            height: 200px; /* Explicitly set a more compact height */
            overflow: hidden; /* Hide any overflow if widget is larger */
        }

        /* Responsive Design for smaller screens */
        @media (max-width: 1024px) {
            .input-and-metrics-container {
                flex-direction: column; /* Stack input and metrics on smaller screens */
            }
            .input-fields-column {
                max-width: 100%; /* Allow input column to take full width */
            }
            .results-grid {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* Allow even smaller min width */
            }
        }

        @media (max-width: 768px) {
            body {
                margin: 10px auto;
                padding: 10px;
            }
            .results-grid {
                grid-template-columns: 1fr; /* Stack columns on small screens */
            }
        }
    </style>
</head>
<body>
    <h1>üìä Intrinsic Value Calculator</h1>

    <!-- New container for input fields and additional metrics -->
    <div class="input-and-metrics-container">
        <div class="input-fields-column">
            <div class="input-group">
                <label for="symbol">Stock Symbol:</label>
                <input type="text" id="symbol" placeholder="e.g., AAPL">
            </div>

            <div class="input-group">
                <label for="growth">Estimated Annual Growth Rate (%):</label>
                <input type="number" id="growth" placeholder="e.g., 10">
            </div>

            <div class="input-group">
                <label for="pe">Expected Future P/E Ratio:</label>
                <input type="number" id="pe" placeholder="e.g., 25">
            </div>

            <div class="input-group">
                <label for="discount">Discount Rate (%):</label>
                <input type="number" id="discount" placeholder="e.g., 10">
            </div>

            <button onclick="calculate()">Calculate Intrinsic Value</button>
        </div>

        <!-- Additional Metrics moved here -->
        <div id="extra" class="extra"></div>
    </div>

    <!-- Grid container for results and math -->
    <div class="results-grid">
        <div id="result" class="output"></div>
        <div id="pessimistic" class="output pessimistic"></div>
        <div id="optimistic" class="output optimistic"></div>
        <div id="math" class="math"></div>
    </div>

    <!-- Finnhub Recommendation Widget -->
    <div id="recommendation-widget">
        <h2>Stock Recommendations</h2>
        <script src="https://widget.finnhub.io/widgets/stocks/recommendation.js" type="text/javascript"></script>
        <div class="finnhub-widget-container">
            <!-- Data symbol is set dynamically by JavaScript -->
            <div id="widget-symbol" class="finnhub-widget" data-symbol="AAPL" data-theme="light" data-height="200"></div>
        </div>
    </div>

<script>
    // Your Finnhub API Key
    const API_KEY = "d0kuab9r01qhb02558rgd0kuab9r01qhb02558s0";
    const years = 5; // Number of years for growth calculation

    /**
     * Calculates the intrinsic value of a stock based on user inputs and fetched data.
     */
    async function calculate() {
        // Get user inputs from the form
        const symbol = document.getElementById("symbol").value.toUpperCase();
        const userGrowthRate = parseFloat(document.getElementById("growth").value) / 100;
        const expectedPE = parseFloat(document.getElementById("pe").value);
        const discountRate = parseFloat(document.getElementById("discount").value) / 100;

        // Get references to output divs
        const resultDiv = document.getElementById("result");
        const pessimisticDiv = document.getElementById("pessimistic");
        const optimisticDiv = document.getElementById("optimistic");
        const extraDiv = document.getElementById("extra"); // Still reference extraDiv
        const mathDiv = document.getElementById("math");
        const widgetDiv = document.getElementById("widget-symbol");

        // Clear previous results and show a loading indicator
        resultDiv.innerHTML = "<strong>Loading data...</strong>";
        pessimisticDiv.innerHTML = "";
        optimisticDiv.innerHTML = "";
        extraDiv.innerHTML = ""; // Clear extraDiv even though it's moved
        mathDiv.innerHTML = "";

        try {
            // Fetch stock data concurrently using Promise.all
            const [profileRes, quoteRes, metricsRes] = await Promise.all([
                fetch(`https://finnhub.io/api/v1/stock/profile2?symbol=${symbol}&token=${API_KEY}`),
                fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${API_KEY}`),
                fetch(`https://finnhub.io/api/v1/stock/metric?symbol=${symbol}&metric=all&token=${API_KEY}`)
            ]);

            // Parse JSON responses
            const profile = await profileRes.json();
            const quote = await quoteRes.json();
            const metrics = await metricsRes.json();

            // Validate essential data
            if (!profile || !quote || !metrics || !quote.c || !metrics.metric || !metrics.metric["epsTTM"]) {
                resultDiv.innerHTML = "‚ö†Ô∏è <strong>Error:</strong> Could not fetch complete data for this symbol. Please ensure the symbol is correct and try again.";
                pessimisticDiv.innerHTML = "";
                optimisticDiv.innerHTML = "";
                extraDiv.innerHTML = "";
                return; // Exit if essential data is missing
            }

            const eps = metrics.metric["epsTTM"] || 0; // Earnings Per Share (Trailing Twelve Months)
            const price = quote.c || 0; // Current stock price
            const currentPE = eps > 0 ? (price / eps).toFixed(2) : "N/A"; // Current P/E ratio
            const forwardPE = metrics.metric["peExclExtraTTM"] || "N/A"; // Forward P/E (if available)

            /**
             * Calculates the intrinsic value of a stock using a discounted cash flow-like model.
             * @param {number} eps - Earnings Per Share.
             * @param {number} growthRate - Annual growth rate (as a decimal).
             * @param {number} peRatio - Expected future P/E ratio.
             * @param {number} discountRate - Discount rate (as a decimal).
             * @returns {object} Contains intrinsic value and intermediate calculation steps.
             */
            function calculateIntrinsic(eps, growthRate, peRatio, discountRate) {
                let intrinsicValue = 0;
                let futureEPSValues = []; // To store EPS for each projected year
                let discountedFutureValues = []; // To store discounted EPS for each year

                // Calculate discounted future EPS for 'years' period
                for (let t = 1; t <= years; t++) {
                    const futureEPS = eps * Math.pow(1 + growthRate, t);
                    const discounted = futureEPS / Math.pow(1 + discountRate, t);
                    intrinsicValue += discounted;
                    futureEPSValues.push(futureEPS.toFixed(2));
                    discountedFutureValues.push(discounted.toFixed(2));
                }

                // Calculate Terminal Value (value of the company beyond the 'years' period)
                const terminalEPS = eps * Math.pow(1 + growthRate, years);
                const terminalValue = terminalEPS * peRatio;
                const discountedTerminal = terminalValue / Math.pow(1 + discountRate, years);
                intrinsicValue += discountedTerminal;

                return { intrinsicValue, futureEPSValues, discountedFutureValues, terminalEPS: terminalEPS.toFixed(2), terminalValue: terminalValue.toFixed(2), discountedTerminal: discountedTerminal.toFixed(2) };
            }

            // Calculate intrinsic value for base, pessimistic, and optimistic scenarios
            const base = calculateIntrinsic(eps, userGrowthRate, expectedPE, discountRate);
            const pessimistic = calculateIntrinsic(eps, userGrowthRate - 0.02, expectedPE - 2, discountRate); // 2% lower growth, 2 lower P/E
            const optimistic = calculateIntrinsic(eps, userGrowthRate + 0.02, expectedPE + 2, discountRate); // 2% higher growth, 2 higher P/E

            // Calculate upside/downside potential
            const baseUpside = price > 0 ? ((base.intrinsicValue - price) / price * 100).toFixed(2) : "N/A";
            const pessimisticUpside = price > 0 ? ((pessimistic.intrinsicValue - price) / price * 100).toFixed(2) : "N/A";
            const optimisticUpside = price > 0 ? ((optimistic.intrinsicValue - price) / price * 100).toFixed(2) : "N/A";

            // Display results in the main output div
            resultDiv.innerHTML = `
                <h3>${profile.name || symbol} - Base Scenario</h3>
                <p>Expected P/E: <strong>${expectedPE}</strong></p>
                <p>Growth Rate: <strong>${(userGrowthRate * 100).toFixed(2)}%</strong></p>
                <p>Discount Rate: <strong>${(discountRate * 100).toFixed(2)}%</strong></p>
                <p style="font-size: 1.1em; margin-top: 8px; color: ${baseUpside >= 0 ? 'var(--success-color)' : 'var(--error-color)'};">
                    <strong>Intrinsic Value: $${base.intrinsicValue.toFixed(2)} (${baseUpside}% ${baseUpside >= 0 ? "Upside" : "Downside"})</strong>
                </p>
            `;

            // Display pessimistic scenario results
            pessimisticDiv.innerHTML = `
                <h3>üòï Pessimistic Scenario</h3>
                <p>Growth Rate: <strong>${((userGrowthRate - 0.02) * 100).toFixed(2)}%</strong></p>
                <p>Future P/E: <strong>${expectedPE - 2}</strong></p>
                <p style="font-size: 0.95em; margin-top: 6px;">
                    Intrinsic Value: <strong>$${pessimistic.intrinsicValue.toFixed(2)} (${pessimisticUpside}% ${pessimisticUpside >= 0 ? "Upside" : "Downside"})</strong>
                </p>
            `;

            // Display optimistic scenario results
            optimisticDiv.innerHTML = `
                <h3>üòÑ Optimistic Scenario</h3>
                <p>Growth Rate: <strong>${((userGrowthRate + 0.02) * 100).toFixed(2)}%</strong></p>
                <p>Future P/E: <strong>${expectedPE + 2}</strong></p>
                <p style="font-size: 0.95em; margin-top: 6px;">
                    Intrinsic Value: <strong>$${optimistic.intrinsicValue.toFixed(2)} (${optimisticUpside}% ${optimisticUpside >= 0 ? "Upside" : "Downside"})</strong>
                </p>
            `;

            // Display additional metrics
            extraDiv.innerHTML = `
                <h3>üì¶ Additional Metrics</h3>
                <p>EPS (TTM): <strong>$${eps.toFixed(2)}</strong></p>
                <p>Current Price: <strong>$${price.toFixed(2)}</strong></p>
                <p>Current P/E: <strong>${currentPE}</strong></p>
                <p>Forward P/E: <strong>${forwardPE}</strong></p>
                <p>52-Week Range: <strong>$${quote.l} ‚Äì $${quote.h}</strong></p>
                <p>Market Cap: <strong>$${Number(metrics.metric["marketCapitalization"] || 0).toLocaleString()}</strong></p>
                <p>Dividend Yield: <strong>${(metrics.metric["dividendYieldIndicatedAnnual"] || 0).toFixed(2)}%</strong></p>
            `;

            // Display the detailed valuation formula and steps
            let mathContent = `Valuation Formula (for Base Scenario):

EPS: $${eps.toFixed(2)} | Growth: ${(userGrowthRate * 100).toFixed(2)}% | Discount: ${(discountRate * 100).toFixed(2)}% | Future P/E: ${expectedPE} | Years: ${years}

Step 1: Future EPS (EPS √ó (1+G)^t):
Y1: $${base.futureEPSValues[0]} | Y2: $${base.futureEPSValues[1]} | Y3: $${base.futureEPSValues[2]} | Y4: $${base.futureEPSValues[3]} | Y5: $${base.futureEPSValues[4]}

Step 2: Discounted EPS (Future EPS / (1+D)^t):
PV Y1: $${base.discountedFutureValues[0]} | PV Y2: $${base.discountedFutureValues[1]} | PV Y3: $${base.discountedFutureValues[2]} | PV Y4: $${base.discountedFutureValues[3]} | PV Y5: $${base.discountedFutureValues[4]}

Step 3: Terminal Value (TV) at Year ${years}:
Terminal EPS = $${base.terminalEPS}
TV = Terminal EPS √ó Future P/E = $${base.terminalValue}

Step 4: Discounted Terminal Value:
Disc. TV = TV / (1+D)^${years} = $${base.discountedTerminal}

Step 5: Sum all Discounted Values:
Intrinsic Value = (Sum PV Y1-${years}) + Disc. TV = $${base.intrinsicValue.toFixed(2)}`;

            mathDiv.textContent = mathContent;

            // Update the Finnhub widget with the new stock symbol
            if (widgetDiv) {
                widgetDiv.setAttribute("data-symbol", symbol);
                widgetDiv.innerHTML = ""; // Clear content to trigger a refresh
            }

        } catch (error) {
            // Display a user-friendly error message
            resultDiv.innerHTML = "‚ö†Ô∏è <strong>Error fetching data.</strong> Please check the stock symbol and your internet connection. Also, ensure your API key is valid and not rate-limited.";
            pessimisticDiv.innerHTML = "";
            optimisticDiv.innerHTML = "";
            extraDiv.innerHTML = "";
            mathDiv.innerHTML = "";
            console.error("Calculation error:", error); // Log the detailed error for debugging
        }
    }
</script>
</body>
</html>
